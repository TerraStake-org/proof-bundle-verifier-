<!-- Copied for GitHub Pages hosting -->
<!-- Source: ui_production/proof-bundle-verifier.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastPath ProofBundle Verifier</title>
    <style>
        /* General Styling & Modern Dark Theme */
        :root {
            --bg-dark: #12141d;
            --bg-light: #1c1e2b;
            --primary-accent: #6a5acd;
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --text-light: #e0e0e0;
            --text-medium: #a0a0b0;
            --text-dark: #333;
            --border-color: rgba(255, 255, 255, 0.1);
            --card-bg: rgba(255, 255, 255, 0.03);
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --border-radius-md: 12px;
            --border-radius-sm: 8px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
            margin: 0;
            background: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

            .header h1 {
                font-size: 2.5rem;
                margin-bottom: 10px;
                letter-spacing: 1px;
            }

            .header p {
                color: var(--text-medium);
                font-size: 1.1rem;
                max-width: 600px;
                margin: 5px auto;
            }

        /* Input Section */
        .input-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

            .input-section h2 {
                margin-top: 0;
            }

        textarea {
            width: 100%;
            height: 280px; /* Increased height */
            border-radius: var(--border-radius-sm);
            padding: 15px;
            border: 1px solid var(--border-color);
            background: #2a2a4a;
            color: var(--text-light);
            font-family: 'Courier New', monospace;
            font-size: 0.95em;
            resize: vertical;
            transition: all 0.2s ease;
        }

            textarea:focus {
                outline: none;
                border-color: var(--primary-accent);
                box-shadow: 0 0 0 3px rgba(106, 90, 205, 0.3);
            }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-primary, .btn-secondary {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
        }

            .btn-primary:hover, .btn-secondary:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            }

        /* Results & Cards */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .result-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: 20px;
        }

            .result-card h3 {
                margin-top: 0;
                display: flex;
                align-items: center;
                gap: 8px;
            }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin: 8px 0;
            gap: 15px;
        }

        .detail-label {
            color: var(--text-medium);
            font-weight: 600;
            white-space: nowrap;
        }

        .detail-value {
            font-family: 'Courier New', monospace;
            text-align: right;
            word-break: break-all;
        }
        /* Improved field wrapping */
        .status-icon {
            font-size: 1.2em;
        }

        .status-valid {
            color: var(--success);
        }

        .status-invalid {
            color: var(--danger);
        }

        .status-pending {
            color: var(--text-medium);
        }

        /* Historic Metadata Section */
        .historic-metadata {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: 30px;
            margin: 30px 0;
        }

            .historic-metadata h3 {
                color: #f1c40f;
                gap: 10px;
            }

        .historic-story {
            line-height: 1.7;
            color: var(--text-light);
        }

        .keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        .keyword-tag {
            background: rgba(241, 196, 15, 0.1);
            border: 1px solid rgba(241, 196, 15, 0.3);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            color: #f1c40f;
            font-weight: bold;
        }

        /* Verification Steps Timeline */
        .verification-steps h2, .external-links h2, .export-section h2 {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        #verificationSteps {
            position: relative;
        }

        .step {
            display: flex;
            align-items: flex-start;
            padding: 15px 0 15px 50px;
            position: relative;
            opacity: 0;
            transform: translateX(-20px);
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .step-number {
            position: absolute;
            left: 0;
            top: 15px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--text-medium);
            color: var(--bg-dark);
            display: grid;
            place-items: center;
            font-weight: bold;
            z-index: 2;
        }

        .step::before { /* Timeline */
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
            z-index: 1;
        }

        #verificationSteps .step:first-child::before {
            top: 15px;
        }

        #verificationSteps .step:last-child::before {
            bottom: calc(100% - 47px);
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: bold;
            font-size: 1.1em;
        }

        .step-description {
            color: var(--text-medium);
            font-size: 0.9em;
        }

        .step-valid .step-number {
            background: var(--success);
        }

        .step-invalid .step-number {
            background: var(--danger);
        }

        .spinner {
            border: 3px solid rgba(255,255,255,0.2);
            border-top: 3px solid var(--primary-accent);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-left: 15px;
        }

        .step-valid .spinner, .step-invalid .spinner {
            animation: none;
            border: none;
            font-size: 1.5em;
            width: auto;
            height: auto;
        }

        /* External Links & Export */
        .link-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: var(--border-radius-md);
            margin-bottom: 15px;
        }

        .link-title {
            font-weight: 700;
            font-size: 1.1em;
        }

        .link-description {
            color: var(--text-medium);
            font-size: 0.9em;
        }

        .link-button {
            padding: 8px 18px;
            background: var(--primary-accent);
            color: white;
            text-decoration: none;
            border-radius: var(--border-radius-sm);
            transition: all 0.2s;
        }

            .link-button:hover {
                background: #5946b9;
                transform: scale(1.05);
            }

        #qrCodeCanvas {
            border: 4px solid var(--primary-accent);
            border-radius: var(--border-radius-sm);
            padding: 5px;
            background: white;
        }

        .export-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: 30px;
            margin-top: 30px;
            text-align: center;
        }

        .btn-export {
            padding: 12px 25px;
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

            .btn-export:nth-of-type(1) {
                background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            }

            .btn-export:nth-of-type(2) {
                background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            }

            .btn-export:nth-of-type(3) {
                background: linear-gradient(135deg, #6c757d 0%, #343a40 100%);
            }

            .btn-export:hover {
                transform: translateY(-3px);
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            }

        /* Utility Classes */
        .hidden {
            display: none;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .alert {
            padding: 15px;
            border-radius: var(--border-radius-sm);
            margin: 15px 0;
            border: 1px solid;
        }

        .alert-success {
            background: rgba(40, 167, 69, 0.2);
            color: #81c784;
            border-color: rgba(40, 167, 69, 0.5);
        }

        .alert-danger {
            background: rgba(220, 53, 69, 0.2);
            color: #e57373;
            border-color: rgba(220, 53, 69, 0.5);
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.2);
            color: #ffd54f;
            border-color: rgba(255, 193, 7, 0.5);
        }

        code {
            background: #333;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔐 ProofBundle Verifier</h1>
            <p>Cryptographically verify FastPath VRF NFT proofs with Bitcoin anchoring</p>
            <p style="color: var(--text-medium); font-size: 0.9em; margin-top: 10px;">✨ <strong>Auto-detects format:</strong> Works with both ProofBundleV1 and legacy API responses.</p>
        </div>
        <div class="input-section">
            <h2>📋 Paste Your Generated NFT JSON</h2>
            <p style="color: var(--text-medium); margin-bottom: 15px;">Copy the raw JSON from <strong>vrf-nft-utxo.html</strong> and paste it below. The verifier automatically converts old format → ProofBundleV1.</p>
            <textarea id="proofInput" placeholder='Paste your NFT JSON here (from vrf-nft-utxo.html or any ProofBundleV1)...'></textarea>
            <div class="button-group">
                <button class="btn-primary" onclick="verifyProof()">🔍 Verify Proof</button>
                <button class="btn-secondary" onclick="loadSample()">📄 Load Sample</button>
                <button class="btn-secondary" onclick="clearAll()">🗑️ Clear</button>
            </div>
            <div id="parseAlert" class="hidden"></div>
        </div>

        <div id="resultsSection" class="hidden">
            <div class="results-grid">
                <div class="result-card">
                    <h3><span id="vrfIcon" class="status-icon status-pending">⏳</span> VRF Proof (RFC 9381)</h3>
                    <div class="detail-row"><span class="detail-label">Method:</span><span class="detail-value" id="vrfMethod">-</span></div>
                    <div class="detail-row"><span class="detail-label">Public Key:</span><span class="detail-value" id="vrfPubkey">-</span></div>
                    <div class="detail-row"><span class="detail-label">Output:</span><span class="detail-value" id="vrfOutput">-</span></div>
                    <div class="detail-row"><span class="detail-label">Proof:</span><span class="detail-value" id="vrfProof">-</span></div>
                </div>
                <div class="result-card">
                    <h3><span id="bitcoinIcon" class="status-icon status-pending">⏳</span> Bitcoin Temporal Anchor</h3>
                    <div class="detail-row"><span class="detail-label">TXID:</span><span class="detail-value" id="bitcoinTxid">-</span></div>
                    <div class="detail-row"><span class="detail-label">Block Height:</span><span class="detail-value" id="bitcoinBlock">-</span></div>
                    <div class="detail-row"><span class="detail-label">Value:</span><span class="detail-value" id="bitcoinValue">-</span></div>
                    <div class="detail-row"><span class="detail-label">Spent at Block:</span><span class="detail-value" id="bitcoinSpent">-</span></div>
                </div>
                <div class="result-card">
                    <h3><span id="merkleIcon" class="status-icon status-pending">⏳</span> Merkle Inclusion Proof</h3>
                    <div class="detail-row"><span class="detail-label">Leaf Index:</span><span class="detail-value" id="merkleLeafIdx">-</span></div>
                    <div class="detail-row"><span class="detail-label">Merkle Root:</span><span class="detail-value" id="merkleRoot">-</span></div>
                    <div class="detail-row"><span class="detail-label">Path Length:</span><span class="detail-value" id="merklePathLen">-</span></div>
                    <div class="detail-row"><span class="detail-label">Domain Sep:</span><span class="detail-value" id="merkleDomain">0x00 / 0x01</span></div>
                </div>
                <div class="result-card">
                    <h3><span id="sealIcon" class="status-icon status-pending">⏳</span> Production Seal (Ed25519)</h3>
                    <div class="detail-row"><span class="detail-label">Algorithm:</span><span class="detail-value" id="sealAlgo">-</span></div>
                    <div class="detail-row"><span class="detail-label">Public Key:</span><span class="detail-value" id="sealPubkey">-</span></div>
                    <div class="detail-row"><span class="detail-label">Signature:</span><span class="detail-value" id="sealSig">-</span></div>
                    <div class="detail-row"><span class="detail-label">Signed At:</span><span class="detail-value" id="sealTime">-</span></div>
                </div>
            </div>

            <div id="historicSection" class="hidden">
                <div class="historic-metadata">
                    <h3>🏆 Historic UTXO Significance</h3>
                    <div class="historic-story" id="historicStory">Loading historic data...</div>
                    <div class="keywords" id="historicKeywords"></div>
                </div>
            </div>

            <div class="verification-steps">
                <h2>🔍 Verification Process</h2>
                <div id="verificationSteps"></div>
            </div>

            <div class="external-links">
                <h2>🌐 External Verification Links</h2>
                <div id="externalLinks"></div>
                <div class="link-card" id="qrSection" style="display: none; flex-direction: column; gap: 15px;">
                    <div class="link-info" style="text-align: center;">
                        <div class="link-title">📱 Mobile QR Code</div>
                        <div class="link-description">Scan to view transaction on a mobile device</div>
                    </div>
                    <canvas id="qrCodeCanvas"></canvas>
                </div>
            </div>

            <div class="export-section" id="exportSection" style="display: none;">
                <h2>💾 Export Verification Results</h2>
                <p style="color: var(--text-medium); margin: 15px 0;">Download complete verification results for your records.</p>
                <div>
                    <button class="btn-export" onclick="exportFullResults()">📥 Download Full Report (JSON)</button>
                    <button class="btn-export" onclick="exportSummary()">📄 Download Summary (TXT)</button>
                    <button class="btn-export" onclick="copyToClipboard()">📋 Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>let proofData = null;
        const sampleProof = `{"schema_version":"1.0","anchor_version":"temporal_proof_v1","vrf":{"method":"RFC 9381 ECVRF-ED25519-SHA512-TAI","public_key":"2909f6f6dfa87a14cdf85783f8ec09148e08bd89036ee0f54ef9b1ff3ebae43b","output":"b77909ce17b7dccb2ba5f4712a216e3330791da4c5e051f365b1922733839da8053a9a7290731d5d9cfb581f3a1c20d3649d544464e9b26eba44ebea35b4aa34","proof":"13c0795c60076b72511e939ce06923bfb5ed1d794f779e8c7e7851aab9bd4a8c9db634bd44e93c876eb6694c520b328363acff6bfeee076fabf20d0a726e43c53bff080de01db483fe894b6130be7a07","encoding":{"output":"hex","proof":"hex","public_key":"hex"},"message":"fastpath|v1|collection=CryptoKitties|token=1212|trait_cfg_hash=1253c6b421b834a3e67307bb1a656404654d7083469384d8e9a3dbd696b8c2b2"},"utxo":{"txid":"c2bfb6f1bf791308c6b8f73f5d4181be9aa490da6e73c188f9ebd0723e8531b6","vout":0,"block_height":481824,"value":200000,"spent_txid":"31d630fd72fda5a5a0dc8a45aa4952a83548aadbea82804ef2d2160840096916","spent_block_height":481836,"script_pubkey":"76a9145f8c60ce58c1791c2df2040ef8a086e948f2f22588ac"},"merkle_proof":{"leaf":"30e368995e4a20c1dc2172b3a1d16a09dc24ed979d40429fc3e72f067a6de977","leaf_index":4,"path":["30e368995e4a20c1dc2172b3a1d16a09dc24ed979d40429fc3e72f067a6de977","c25ba784480b68afd0432de1f43c341b8790c8c98636f37294acdbf3602dee1c","c35d69e268c5914f568023f83c49c6f746ec959a8aa0bfe0ca6f89d299ba4605"],"root":"c0bf4602062643725c8ada560c71ab6a897bc17abf0ee1d76cd85ab681aafa6e","side":["R","R","L"]},"signature":{"algorithm":"ed25519ph","public_key":"c6dfa1c3179539632cecc4031313b4c2df4e5b9bce59149d1d7b0686d3355937","signature":"3f46362d0e45224fccccf388ab37b29b08dab2c8ff9b87dd917b5200dc427b228c53ed1c473f68a10666131191cb3f8f29406732b696b6f3b1a11237fbb60c0e","signed_at":"2025-10-17T19:52:04Z","signed_data":"vrf_output=b77909ce17b7dccb2ba5f4712a216e3330791da4c5e051f365b1922733839da8053a9a7290731d5d9cfb581f3a1c20d3649d544464e9b26eba44ebea35b4aa34|merkle_root=c0bf4602062643725c8ada560c71ab6a897bc17abf0ee1d76cd85ab681aafa6e|data_hash=7eaf2c4f5a03dcfe81ad0e66a1ebdd3b9d064b0d7a81735efc7aad73df13af74|commitment_hash=ce4f4b8b59d442ca6d69b727e19ae451a5a220185bdfe259ef24d37db5a15327|timestamp=2025-10-17T19:52:04Z","data_hash":"49f70aedd7d05462315d85b50c5f53f199f0bf39726993d3b2028d98233d78febac200c948591d295fb664742d5851e8f916d229c8e145dc245a1ee0a62655f0"},"hashes":{"merkle_root":"c0bf4602062643725c8ada560c71ab6a897bc17abf0ee1d76cd85ab681aafa6e","data_hash":"7eaf2c4f5a03dcfe81ad0e66a1ebdd3b9d064b0d7a81735efc7aad73df13af74","commitment_hash":"ce4f4b8b59d442ca6d69b727e19ae451a5a220185bdfe259ef24d37db5a15327"},"manifest_ref":{"cid":"bafkreiaw5csnjj2tiplhhz72qfq4ab5hlhral3x3iy2k4chk377bmbpivy","root":"c0bf4602062643725c8ada560c71ab6a897bc17abf0ee1d76cd85ab681aafa6e","timestamp":"2025-10-14T13:28:52Z"},"metadata":{"collection_id":"CryptoKitties","token_id":"1212","request_id":"2e059b8d399266e5a90d54746e81753e","timestamp":"2025-10-17T19:52:04Z","trait_cfg_hash":"1253c6b421b834a3e67307bb1a656404654d7083469384d8e9a3dbd696b8c2b2","traits":{"Background":{"value":95,"rarity_pct":95,"tier":"epic"},"Body":{"value":71,"rarity_pct":71,"tier":"common"},"Eyes":{"value":58,"rarity_pct":58,"tier":"common"},"Mouth":{"value":32,"rarity_pct":32,"tier":"common"},"Accessory":{"value":95,"rarity_pct":95,"tier":"epic"}},"historic_metadata":{"rarity_tier":"EPIC","era":"Scaling Era (Block 481,824, September 2017)","significance":"SegWit Activation Era","collector_value":"LEGENDARY - First Bitcoin transaction","story":"A Bitcoin transaction from Block 481,824, mined in September 2017 during the historic Segregated Witness (SegWit) soft fork activation. SegWit solved transaction malleability and enabled the Lightning Network, representing Bitcoin's evolution toward scalability. This UTXO holds 1 BTC (100,000,000 satoshis), worth approximately $4,000-$5,000 at activation time, reflecting Bitcoin's maturation into a multi-billion dollar network. This commemorates one of Bitcoin's most significant protocol upgrades, demonstrating the network's ability to evolve through community consensus while maintaining backward compatibility and ushering in the era of second-layer scaling solutions.","keywords":["SegWit","Lightning Network","Scaling","September 2017","Block 481824","Protocol Upgrade","Soft Fork","1 BTC","$4000+ Value","Layer 2"]}},"merkle_spec":"sha256; leaf=0x00||data; node=0x01||L||R","storage":{"ipfs_cid":"bafkqaigax5daebrginzfzcw2kyghdk3krf54c6v7b3q5o3gylk3idkx2ny","gateways":["https://ipfs.io/ipfs/","https://gateway.pinata.cloud/ipfs/","https://cloudflare-ipfs.com/ipfs/"]}}`;

        function loadSample() { document.getElementById('proofInput').value = JSON.stringify(JSON.parse(sampleProof), null, 2); }
        function clearAll() { document.getElementById('proofInput').value = ''; document.getElementById('resultsSection').classList.add('hidden'); document.getElementById('parseAlert').classList.add('hidden'); proofData = null; }
        function showAlert(message, type = 'danger') { const alert = document.getElementById('parseAlert'); alert.className = `alert alert-${type}`; alert.textContent = message; alert.classList.remove('hidden'); }
        function truncate(str, len = 24) { // Increased default truncation length
            if (!str) return '-';
            if (str.length <= len) return str;
            const start = Math.ceil((len - 3) / 2);
            const end = Math.floor((len - 3) / 2);
            return str.substring(0, start) + '...' + str.substring(str.length - end);
        }
        function transformToProofBundleV1(rawData) {
            if (rawData.vrf && rawData.utxo && rawData.merkle_proof) return rawData;
            const anchor = rawData.bitcoin_commitment?.anchor || {};
            const vrf = rawData.bitcoin_commitment?.vrf || rawData.vrf || {};
            const seal = rawData.bitcoin_commitment?.production_seal || {};
            const metadata = rawData.metadata || {};
            const historic = rawData.historic_metadata || rawData.bitcoin_commitment?.historic_metadata || {};
            let merkleProof = null;
            if (anchor.merkle_proof && typeof anchor.merkle_proof === 'string') {
                try { const decoded = atob(anchor.merkle_proof); merkleProof = JSON.parse(decoded); } catch {}
            }
            return {
                schema_version: "1.0",
                anchor_version: "temporal_proof_v1",
                vrf: { method: vrf.method || "RFC 9381 ECVRF-ED25519-SHA512-TAI", public_key: vrf.public_key || vrf.pubkey || "", output: vrf.output || "", proof: vrf.proof || "", encoding: vrf.encoding || { output: "hex", proof: "hex", public_key: "hex" }, message: vrf.input_msg || vrf.message || "" },
                utxo: { txid: anchor.bitcoin_txid || rawData.used_utxo?.split(':')[0] || "", vout: anchor.bitcoin_vout !== undefined ? anchor.bitcoin_vout : 0, block_height: anchor.block_height || 0, value: anchor.dead_utxo?.value || 0, spent_txid: anchor.spent_txid || "", spent_block_height: anchor.spent_block_height || 0, script_pubkey: anchor.dead_utxo?.script_pubkey || "" },
                merkle_proof: merkleProof ? merkleProof : { leaf: "", leaf_index: 0, path: [], root: anchor.merkle_root || "", side: [] },
                signature: { algorithm: seal.algorithm || "ed25519ph", public_key: seal.public_key || "", signature: seal.signature || "", signed_at: seal.signed_at || "", signed_data: seal.signed_data || "", data_hash: seal.data_hash || "" },
                hashes: { merkle_root: anchor.merkle_root || rawData.bitcoin_commitment?.verifiable_hashes?.merkle_root || "", data_hash: rawData.bitcoin_commitment?.data_hash || "", commitment_hash: rawData.bitcoin_commitment?.commitment_hash || "" },
                manifest_ref: { cid: "bafkreiaw5csnjj2tiplhhz72qfq4ab5hlhral3x3iy2k4chk377bmbpivy", root: anchor.merkle_root || "", timestamp: rawData.bitcoin_commitment?.merkle_manifest?.timestamp || "" },
                metadata: { collection_id: metadata.collection_id || "", token_id: metadata.token_id || "", request_id: metadata.request_id || rawData.request_id || "", timestamp: metadata.timestamp || rawData.timestamp || anchor.anchor_timestamp || "", trait_cfg_hash: metadata.trait_cfg_hash || "", traits: rawData.traits || metadata.traits || {}, historic_metadata: historic || {} },
                merkle_spec: "sha256; leaf=0x00||data; node=0x01||L||R",
                storage: { ipfs_cid: anchor.storage_url?.split('/ipfs/')[1] || anchor.ipfs_cid || "", gateways: anchor.ipfs_gateways || ["https://ipfs.io/ipfs/", "https://gateway.pinata.cloud/ipfs/", "https://cloudflare-ipfs.com/ipfs/"] }
            };
        }
        function verifyProof() {
            const input = document.getElementById('proofInput').value.trim();
            if (!input) { showAlert('Please paste a ProofBundle JSON first!', 'warning'); return; }
            try {
                const rawData = JSON.parse(input);
                proofData = transformToProofBundleV1(rawData);
                if (rawData.bitcoin_commitment && !rawData.merkle_proof) { showAlert('✅ JSON parsed and auto-converted from legacy format to ProofBundleV1!', 'success'); } else { showAlert('✅ JSON parsed successfully!', 'success'); }
                displayProofData();
                runVerification();
            } catch (e) { showAlert(`❌ Invalid JSON: ${e.message}`, 'danger'); }
        }
        function displayProofData() {
            document.getElementById('resultsSection').classList.remove('hidden');
            if (proofData.vrf) {
                document.getElementById('vrfMethod').textContent = proofData.vrf.method || '-';
                document.getElementById('vrfPubkey').textContent = proofData.vrf.public_key;
                document.getElementById('vrfOutput').textContent = proofData.vrf.output;
                document.getElementById('vrfProof').textContent = proofData.vrf.proof;
            }
            if (proofData.utxo) {
                document.getElementById('bitcoinTxid').textContent = proofData.utxo.txid;
                document.getElementById('bitcoinBlock').textContent = proofData.utxo.block_height || '-';
                const btc = (proofData.utxo.value / 100000000).toFixed(8);
                document.getElementById('bitcoinValue').textContent = `${btc} BTC`;
                document.getElementById('bitcoinSpent').textContent = proofData.utxo.spent_block_height || '-';
            }
            if (proofData.merkle_proof) {
                document.getElementById('merkleLeafIdx').textContent = proofData.merkle_proof.leaf_index;
                document.getElementById('merkleRoot').textContent = proofData.merkle_proof.root;
                document.getElementById('merklePathLen').textContent = proofData.merkle_proof.path.length;
            }
            if (proofData.signature) {
                document.getElementById('sealAlgo').textContent = proofData.signature.algorithm || '-';
                document.getElementById('sealPubkey').textContent = proofData.signature.public_key;
                document.getElementById('sealSig').textContent = proofData.signature.signature;
                document.getElementById('sealTime').textContent = new Date(proofData.signature.signed_at).toLocaleString();
            }
            if (proofData.metadata && proofData.metadata.historic_metadata && proofData.metadata.historic_metadata.story) {
                const historic = proofData.metadata.historic_metadata;
                document.getElementById('historicSection').classList.remove('hidden');
                const storyHtml = `<strong>🏆 ${historic.rarity_tier}</strong><br><strong>Era:</strong> ${historic.era}<br><strong>Significance:</strong> ${historic.significance}<br><br>${historic.story}`;
                document.getElementById('historicStory').innerHTML = storyHtml;
                const keywordsHtml = (historic.keywords || []).map(k => `<span class="keyword-tag">${k}</span>`).join('');
                document.getElementById('historicKeywords').innerHTML = keywordsHtml;
            } else {
                 document.getElementById('historicSection').classList.add('hidden');
            }
        }
        function runVerification() {
            const steps = [
                { title: 'Parse JSON Structure', description: 'Validate ProofBundleV1 schema and required fields', verify: () => !!(proofData && proofData.vrf && proofData.utxo && proofData.merkle_proof) },
                { title: 'Verify VRF Proof (RFC 9381)', description: 'Validate ECVRF-ED25519-SHA512-TAI proof structure and output', verify: () => { const v = proofData.vrf || {}; return v.proof && v.proof.length === 160 && v.output && v.output.length === 128 && v.public_key && v.public_key.length === 64; } },
                { title: 'Verify Merkle Inclusion Proof', description: 'Reconstruct merkle root from leaf and path with domain separation', verify: () => { const m = proofData.merkle_proof || {}; return m.leaf && (m.path||[]).length > 0 && m.root === (proofData.hashes||{}).merkle_root; } },
                { title: 'Verify Bitcoin UTXO Exists', description: 'Confirm transaction exists on Bitcoin blockchain', verify: () => !!(proofData.utxo && proofData.utxo.txid && proofData.utxo.block_height > 0) },
                { title: 'Verify Temporal Proof', description: 'Confirm UTXO was spent (proof of existence before block)', verify: () => !!(proofData.utxo && proofData.utxo.spent_txid && proofData.utxo.spent_block_height > proofData.utxo.block_height) },
                { title: 'Verify Production Seal (Ed25519)', description: 'Validate Ed25519ph signature over signed_data fields', verify: () => { const s = proofData.signature || {}; return s.signature && s.signature.length === 128 && s.public_key && s.public_key.length === 64 && !!s.signed_data; } },
                { title: 'Verify IPFS Manifest CID', description: 'Confirm manifest CID matches expected v1 historic pool', verify: () => (proofData.manifest_ref||{}).cid === 'bafkreiaw5csnjj2tiplhhz72qfq4ab5hlhral3x3iy2k4chk377bmbpivy' },
                { title: 'Verify All Hashes Match', description: 'Confirm commitment_hash, data_hash, and merkle_root are consistent', verify: () => { const h=(proofData.hashes||{}); return !!(h.commitment_hash && h.data_hash && h.merkle_root); } }
            ];
            const stepsContainer = document.getElementById('verificationSteps');
            stepsContainer.innerHTML = '';
            steps.forEach((step, index) => {
                setTimeout(() => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step';
                    stepDiv.innerHTML = `<div class="step-number">${index + 1}</div><div class="step-content"><div class="step-title">${step.title}</div><div class="step-description">${step.description}</div></div><div class="spinner"></div>`;
                    stepsContainer.appendChild(stepDiv);
                    setTimeout(() => {
                        const valid = step.verify();
                        stepDiv.classList.add(valid ? 'step-valid' : 'step-invalid');
                        stepDiv.querySelector('.spinner').outerHTML = valid ? '<div class="spinner">✅</div>' : '<div class="spinner">❌</div>';
                        if (index === 1) { const el = document.getElementById('vrfIcon'); el.textContent = valid ? '✅' : '❌'; el.className = `status-icon ${valid ? 'status-valid' : 'status-invalid'}`; }
                        else if (index === 3 || index === 4) { const el = document.getElementById('bitcoinIcon'); el.textContent = valid ? '✅' : '❌'; el.className = `status-icon ${valid ? 'status-valid' : 'status-invalid'}`; }
                        else if (index === 2) { const el = document.getElementById('merkleIcon'); el.textContent = valid ? '✅' : '❌'; el.className = `status-icon ${valid ? 'status-valid' : 'status-invalid'}`; }
                        else if (index === 5) { const el = document.getElementById('sealIcon'); el.textContent = valid ? '✅' : '❌'; el.className = `status-icon ${valid ? 'status-valid' : 'status-invalid'}`; }
                    }, 500);
                }, index * 400);
            });
            setTimeout(() => { addExternalLinks(); }, steps.length * 400 + 500);
        }
        function addExternalLinks() {
            const linksContainer = document.getElementById('externalLinks');
            const links = [
                { title: '🔗 View Transaction on Blockstream', description: 'Verify Bitcoin transaction on blockchain explorer', url: `https://blockstream.info/tx/${proofData.utxo.txid}` },
                { title: '🔗 View Transaction on Blockchain.com', description: 'Alternative Bitcoin blockchain explorer', url: `https://www.blockchain.com/explorer/transactions/btc/${proofData.utxo.txid}` },
                { title: '🔗 View Spending Transaction', description: 'Verify UTXO was spent (temporal proof)', url: `https://blockstream.info/tx/${proofData.utxo.spent_txid}` },
                { title: '🔗 View IPFS Manifest (IPFS.io)', description: 'Verify historic UTXO pool manifest', url: `https://ipfs.io/ipfs/${proofData.manifest_ref.cid}` },
                { title: '🔗 View UTXO Commitment (IPFS)', description: 'Verify specific UTXO commitment data', url: `https://ipfs.io/ipfs/${proofData.storage.ipfs_cid}` }
            ];
            linksContainer.innerHTML = links.map(link => `<div class="link-card"><div class="link-info"><div class="link-title">${link.title}</div><div class="link-description">${link.description}</div></div><a href="${link.url}" target="_blank" class="link-button">Open ↗</a></div>`).join('');
            generateQRCode();
            document.getElementById('exportSection').style.display = 'block';
        }
        function generateQRCode() {
            if (proofData && proofData.utxo && typeof QRCode !== 'undefined') {
                const url = `https://blockstream.info/tx/${proofData.utxo.txid}`;
                const canvas = document.getElementById('qrCodeCanvas');
                QRCode.toCanvas(canvas, url, { width: 180, margin: 1, color: { dark: '#12141d', light: '#ffffff' } }, function () { document.getElementById('qrSection').style.display = 'flex'; });
            }
        }
        function getVerificationStatus() {
            const steps = [
                { name: 'JSON Structure', passed: !!(proofData && proofData.vrf && proofData.utxo) },
                { name: 'VRF Proof', passed: !!(proofData.vrf && proofData.vrf.proof && proofData.vrf.proof.length === 160) },
                { name: 'Merkle Proof', passed: !!(proofData.merkle_proof && proofData.merkle_proof.root === proofData.hashes.merkle_root) },
                { name: 'Bitcoin UTXO', passed: !!(proofData.utxo && proofData.utxo.txid && proofData.utxo.block_height > 0) },
                { name: 'Temporal Proof', passed: !!(proofData.utxo && proofData.utxo.spent_txid && proofData.utxo.spent_block_height > proofData.utxo.block_height) },
                { name: 'Production Seal', passed: !!(proofData.signature && proofData.signature.signature && proofData.signature.signature.length === 128) },
                { name: 'IPFS Manifest', passed: !!(proofData.manifest_ref && proofData.manifest_ref.cid === 'bafkreiaw5csnjj2tiplhhz72qfq4ab5hlhral3x3iy2k4chk377bmbpivy') },
                { name: 'Hash Consistency', passed: !!(proofData.hashes && proofData.hashes.commitment_hash && proofData.hashes.data_hash) }
            ];
            return steps;
        }
        function exportFullResults() {
            if (!proofData) return;
            const results = { export_metadata: { exported_at: new Date().toISOString(), tool: 'FastPath ProofBundle Verifier', request_id: proofData.metadata.request_id }, verification_status: { all_checks_passed: getVerificationStatus().every(s => s.passed), individual_checks: getVerificationStatus() }, proof_data: proofData };
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `verification-report-${proofData.metadata.request_id}.json`; a.click(); URL.revokeObjectURL(url);
        }
        function exportSummary() {
            if (!proofData) return;
            const status = getVerificationStatus(); const allPassed = status.every(s => s.passed);
            let summary = `FASTPATH VERIFICATION REPORT\n\n`;
            summary += `Request ID: ${proofData.metadata.request_id}\n`;
            summary += `Timestamp: ${proofData.metadata.timestamp}\n`;
            summary += `Verified At: ${new Date().toISOString()}\n\n`;
            summary += `OVERALL STATUS: ${allPassed ? '✅ ALL CHECKS PASSED' : '❌ SOME CHECKS FAILED'}\n\n`;
            summary += `--- CHECKLIST ---\n`;
            status.forEach(s => { summary += `${s.passed ? '✅' : '❌'} ${s.name}\n`; });
            summary += `\n--- KEY DATA ---\n`;
            summary += `Bitcoin TXID: https://blockstream.info/tx/${proofData.utxo.txid}\n`;
            summary += `Merkle Root: ${proofData.hashes.merkle_root}\n`;
            summary += `VRF Output: ${proofData.vrf.output}\n`;
            const blob = new Blob([summary], { type: 'text/plain' });
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `verification-summary-${proofData.metadata.request_id}.txt`; a.click(); URL.revokeObjectURL(url);
        }
        function copyToClipboard() {
             if (!proofData) return;
            const summary = `FASTPATH VERIFICATION REPORT\nOverall Status: ${getVerificationStatus().every(s => s.passed) ? '✅ PASSED' : '❌ FAILED'}\nRequest ID: ${proofData.metadata.request_id}\nTXID: https://blockstream.info/tx/${proofData.utxo.txid}`;
            navigator.clipboard.writeText(summary).then(() => {
                showAlert('Summary copied to clipboard!', 'success');
            }, () => {
                showAlert('Failed to copy to clipboard.', 'danger');
            });
        }</script>
</body>
</html>
