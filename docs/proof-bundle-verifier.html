<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastPath ProofBundle Verifier</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark-bg: #0f172a;
            --dark-card: rgba(30, 41, 59, 0.7);
            --glass: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-light: #f8fafc;
            --text-muted: #94a3b8;
            --spacing-xs: 0.5rem;
            --spacing-sm: 1rem;
            --spacing-md: 1.5rem;
            --spacing-lg: 2rem;
            --spacing-xl: 3rem;
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #334155 100%);
            color: var(--text-light);
            line-height: 1.6;
            min-height: 100vh;
            padding: var(--spacing-md);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
            padding: var(--spacing-lg);
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.8s ease-out;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            background: linear-gradient(to right, #818cf8, #6366f1);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: inline-block;
        }

        .header p {
            color: var(--text-muted);
            max-width: 800px;
            margin: 0 auto;
            font-size: 1.1rem;
        }

        .header .tagline {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(99, 102, 241, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: var(--spacing-sm);
            color: #c7d2fe;
        }

        .card {
            background: var(--dark-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-bottom: var(--spacing-lg);
            transition: var(--transition);
            animation: slideUp 0.5s ease-out;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            font-size: 1.5rem;
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        textarea {
            width: 100%;
            height: 200px;
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            color: var(--text-light);
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.9rem;
            resize: vertical;
            transition: var(--transition);
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .button-group {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .alert {
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            margin: var(--spacing-md) 0;
            animation: slideIn 0.3s ease-out;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #a7f3d0;
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fecaca;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #fde68a;
        }

        .hidden {
            display: none;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-lg);
            margin-top: var(--spacing-lg);
        }

        .result-card {
            background: var(--dark-card);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            transition: var(--transition);
        }

        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }

        .result-card h3 {
            font-size: 1.1rem;
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin: 10px 0;
            gap: 10px;
        }

        .detail-label {
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.85rem;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .detail-value {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.8rem;
            word-break: break-all;
            text-align: right;
            color: var(--text-light);
        }

        .status-icon {
            margin-right: 6px;
        }

        .status-valid {
            color: var(--success);
        }

        .status-invalid {
            color: var(--danger);
        }

        .status-pending {
            color: var(--warning);
        }

        .historic-metadata {
            background: linear-gradient(135deg, rgba(253, 203, 110, 0.15) 0%, rgba(251, 191, 36, 0.2) 100%);
            border-radius: var(--border-radius);
            padding: var(--spacing-lg);
            margin: var(--spacing-lg) 0;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }

        .historic-metadata h3 {
            color: #fef3c7;
            margin-bottom: var(--spacing-md);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .historic-story {
            background: rgba(15, 23, 42, 0.7);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            line-height: 1.6;
            color: #fef3c7;
        }

        .keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: var(--spacing-md);
        }

        .keyword-tag {
            background: rgba(251, 191, 36, 0.2);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #fef3c7;
            font-weight: 600;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .verification-steps {
            margin: var(--spacing-lg) 0;
        }

        .step {
            display: flex;
            align-items: center;
            padding: var(--spacing-md);
            margin-bottom: 10px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: var(--border-radius);
            border-left: 4px solid transparent;
            transition: var(--transition);
        }

        .step-running {
            border-left-color: var(--warning);
        }

        .step-valid {
            border-left-color: var(--success);
        }

        .step-invalid {
            border-left-color: var(--danger);
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(99, 102, 241, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: var(--spacing-md);
            flex-shrink: 0;
        }

        .step-content {
            flex-grow: 1;
        }

        .step-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .step-description {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .external-links {
            margin: var(--spacing-lg) 0;
        }

        .link-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(15, 23, 42, 0.5);
            padding: var(--spacing-md);
            border-radius: var(--border-radius);
            margin: 10px 0;
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: var(--transition);
        }

        .link-card:hover {
            background: rgba(15, 23, 42, 0.7);
            transform: translateX(5px);
        }

        .link-title {
            font-weight: 700;
        }

        .link-description {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .link-button {
            padding: 8px 16px;
            background: var(--primary);
            color: white;
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: var(--transition);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .link-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .export-section {
            background: rgba(15, 23, 42, 0.7);
            border-radius: var(--border-radius);
            padding: var(--spacing-xl);
            margin-top: var(--spacing-lg);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-export {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin: 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-export.secondary {
            background: linear-gradient(135deg, #6b7280, #4b5563);
        }

        .btn-export.secondary:hover {
            box-shadow: 0 6px 20px rgba(107, 114, 128, 0.4);
        }

        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        #qrSection {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: var(--spacing-lg);
            background: rgba(15, 23, 42, 0.5);
            border-radius: var(--border-radius);
            margin: var(--spacing-md) 0;
        }

        #qrCodeCanvas {
            border: 3px solid var(--primary);
            border-radius: var(--border-radius);
            padding: 10px;
            background: white;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from { 
                opacity: 0;
                transform: translateX(-20px);
            }
            to { 
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .link-card {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .link-button {
                align-self: flex-end;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üîê ProofBundle Verifier</h1>
            <p>Cryptographically verify FastPath VRF NFT proofs with Bitcoin anchoring</p>
            <div class="tagline">
                <span>‚ú®</span>
                <span><strong>Auto-detects format:</strong> Achieve provably fair and secure randomness with VRF-Ed25519. Trust this robust, high-performance cryptographic function to generate unbiased, verifiable random values critical for decentralized consensus, secure lotteries, and robust key generation in your digital world</span>
            </div>
        </div>
        
        <div class="card">
            <h2>üìã Paste Your Generated NFT JSON</h2>
            <p style="color: var(--text-muted); margin-bottom: 15px;">Copy the raw JSON from <strong>vrf-nft-utxo.html</strong> and paste it below. Anyone can use the public key to check that the random output was calculated correctly  ‚Üí ProofBundle.</p>
            <textarea id="proofInput" placeholder='Paste your NFT JSON here (from vrf-nft-utxo.html or any ProofBundleV1)...'></textarea>
            <div class="button-group">
                <button class="btn btn-primary" onclick="verifyProof()">
                    <span>üîç</span> Verify Proof
                </button>
                <button class="btn btn-secondary" onclick="loadSample()">
                    <span>üìÑ</span> Load Sample
                </button>
                <button class="btn btn-secondary" onclick="clearAll()">
                    <span>üóëÔ∏è</span> Clear
                </button>
            </div>
            <div id="parseAlert" class="hidden"></div>
        </div>

        <div id="resultsSection" class="hidden">
            <div class="results-grid">
                <div class="result-card">
                    <h3><span id="vrfIcon" class="status-icon status-pending">‚è≥</span> VRF Proof (RFC 9381)</h3>
                    <div class="detail-row"><span class="detail-label">Method:</span><span class="detail-value" id="vrfMethod">-</span></div>
                    <div class="detail-row"><span class="detail-label">Public Key:</span><span class="detail-value" id="vrfPubkey">-</span></div>
                    <div class="detail-row"><span class="detail-label">Output:</span><span class="detail-value" id="vrfOutput">-</span></div>
                    <div class="detail-row"><span class="detail-label">Proof:</span><span class="detail-value" id="vrfProof">-</span></div>
                </div>
                <div class="result-card">
                    <h3><span id="bitcoinIcon" class="status-icon status-pending">‚è≥</span> Bitcoin Temporal Anchor</h3>
                    <div class="detail-row"><span class="detail-label">TXID:</span><span class="detail-value" id="bitcoinTxid">-</span></div>
                    <div class="detail-row"><span class="detail-label">Block Height:</span><span class="detail-value" id="bitcoinBlock">-</span></div>
                    <div class="detail-row"><span class="detail-label">Value:</span><span class="detail-value" id="bitcoinValue">-</span></div>
                    <div class="detail-row"><span class="detail-label">Spent at Block:</span><span class="detail-value" id="bitcoinSpent">-</span></div>
                </div>
                <div class="result-card">
                    <h3><span id="merkleIcon" class="status-icon status-pending">‚è≥</span> Merkle Inclusion Proof</h3>
                    <div class="detail-row"><span class="detail-label">Leaf Index:</span><span class="detail-value" id="merkleLeafIdx">-</span></div>
                    <div class="detail-row"><span class="detail-label">Merkle Root:</span><span class="detail-value" id="merkleRoot">-</span></div>
                    <div class="detail-row"><span class="detail-label">Path Length:</span><span class="detail-value" id="merklePathLen">-</span></div>
                    <div class="detail-row"><span class="detail-label">Domain Sep:</span><span class="detail-value" id="merkleDomain">0x00 (leaf) / 0x01 (node)</span></div>
                </div>
                <div class="result-card">
                    <h3><span id="sealIcon" class="status-icon status-pending">‚è≥</span> Production Seal (Ed25519)</h3>
                    <div class="detail-row"><span class="detail-label">Algorithm:</span><span class="detail-value" id="sealAlgo">-</span></div>
                    <div class="detail-row"><span class="detail-label">Public Key:</span><span class="detail-value" id="sealPubkey">-</span></div>
                    <div class="detail-row"><span class="detail-label">Signature:</span><span class="detail-value" id="sealSig">-</span></div>
                    <div class="detail-row"><span class="detail-label">Signed At:</span><span class="detail-value" id="sealTime">-</span></div>
                </div>
            </div>

            <div id="historicSection" class="hidden">
                <div class="historic-metadata">
                    <h3>üèÜ Historic UTXO Significance</h3>
                    <div class="historic-story" id="historicStory">Loading historic data...</div>
                    <div class="keywords" id="historicKeywords"></div>
                </div>
            </div>

            <div class="verification-steps">
                <h2>üîç Verification Process</h2>
                <div id="verificationSteps"></div>
            </div>

            <div class="external-links">
                <h2>üåê External Verification Links</h2>
                <div id="externalLinks"></div>
                <div class="link-card" id="qrSection" style="display: none; flex-direction: column; align-items: center; padding: 25px;">
                    <div class="link-info" style="text-align: center; margin-bottom: 15px;">
                        <div class="link-title">üì± Mobile QR Code</div>
                        <div class="link-description">Scan to view transaction on mobile device</div>
                    </div>
                    <canvas id="qrCodeCanvas"></canvas>
                </div>
            </div>

            <div class="export-section" id="exportSection" style="display: none;">
                <h2>üíæ Export Verification Results</h2>
                <p style="color: var(--text-muted); margin: 15px 0;">Download complete verification results for your records</p>
                <button class="btn-export" onclick="exportFullResults()">
                    <span>üì•</span> Download Full Report (JSON)
                </button>
                <button class="btn-export secondary" onclick="exportSummary()">
                    <span>üìÑ</span> Download Summary (TXT)
                </button>
                <button class="btn-export secondary" onclick="copyToClipboard()">
                    <span>üìã</span> Copy to Clipboard
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        // All original JavaScript logic remains exactly the same
        let proofData = null;

        // Merkle Root Manifest from ipfs/fastpath-merkle-root.json
        const MERKLE_MANIFEST = {
            "manifest_version": "1.0",
            "pool_name": "FastPath Historic UTXO Pool (v2 - 5 UTXOs)",
            "generated_at": "2025-10-17T20:34:08Z",
            "merkle_root": "c0bf4602062643725c8ada560c71ab6a897bc17abf0ee1d76cd85ab681aafa6e",
            "merkle_spec": {
                "leaf_hash": "SHA-256(0x00 || commitment_bytes)",
                "node_hash": "SHA-256(0x01 || left_hash || right_hash)"
            },
            "utxo_count": 5,
            "utxos": [
                "f4184fc596403b9d638783cf57adfe4c75c605f6356fbc91338530e9831e9e16:0",
                "0437cd7f8525ceed2324359c2d0ba26006d92d856a9c20fa0241106ee5a597c9:0",
                "a1075db55d416d3ca199f55b6084e2115b9345e16c5cf302fc80e9d5fbf5d48d:0",
                "777ed67c58761dcaf3762e64576591c8d39317bcbebf0cb335e138d6ea438ce2:0",
                "c2bfb6f1bf791308c6b8f73f5d4181be9aa490da6e73c188f9ebd0723e8531b6:0"
            ],
            "publishing_info": {
                "ipfs_cid": "bafkreiaw5csnjj2tiplhhz72qfq4ab5hlhral3x3iy2k4chk377bmbpivy",
                "gateway_url": "https://ipfs.io/ipfs/bafkreiaw5csnjj2tiplhhz72qfq4ab5hlhral3x3iy2k4chk377bmbpivy"
            }
        };

        // Actual Merkle Path Verification using Web Crypto API
        async function verifyMerklePath(leaf, path, sides, expectedRoot) {
            try {
                let currentHash = hexToBytes(leaf);

                for (let i = 0; i < path.length; i++) {
                    const siblingHash = hexToBytes(path[i]);
                    const side = sides[i];

                    // Apply domain separation: 0x01 || left || right
                    // If side='L', sibling is on the LEFT: sibling || current
                    // If side='R', sibling is on the RIGHT: current || sibling
                    let nodeData;
                    if (side === 'L') {
                        nodeData = new Uint8Array([0x01, ...siblingHash, ...currentHash]);
                    } else {
                        nodeData = new Uint8Array([0x01, ...currentHash, ...siblingHash]);
                    }

                    // SHA-256 hash
                    const hashBuffer = await crypto.subtle.digest('SHA-256', nodeData);
                    currentHash = new Uint8Array(hashBuffer);
                }

                const computedRoot = bytesToHex(currentHash);
                return computedRoot === expectedRoot;
            } catch (e) {
                console.error('Merkle verification error:', e);
                return false;
            }
        }

        function hexToBytes(hex) {
            const bytes = new Uint8Array(hex.length / 2);
            for (let i = 0; i < hex.length; i += 2) {
                bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
            }
            return bytes;
        }

        function bytesToHex(bytes) {
            return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
        }
        const sampleProof = `{"schema_version":"1.0","anchor_version":"temporal_proof_v1","vrf":{"method":"RFC 9381 ECVRF-ED25519-SHA512-TAI","public_key":"2909f6f6dfa87a14cdf85783f8ec09148e08bd89036ee0f54ef9b1ff3ebae43b","output":"b77909ce17b7dccb2ba5f4712a216e3330791da4c5e051f365b1922733839da8053a9a7290731d5d9cfb581f3a1c20d3649d544464e9b26eba44ebea35b4aa34","proof":"13c0795c60076b72511e939ce06923bfb5ed1d794f779e8c7e7851aab9bd4a8c9db634bd44e93c876eb6694c520b328363acff6bfeee076fabf20d0a726e43c53bff080de01db483fe894b6130be7a07","encoding":{"output":"hex","proof":"hex","public_key":"hex"},"message":"fastpath|v1|collection=CryptoKitties|token=1212|trait_cfg_hash=1253c6b421b834a3e67307bb1a656404654d7083469384d8e9a3dbd696b8c2b2"},"utxo":{"txid":"c2bfb6f1bf791308c6b8f73f5d4181be9aa490da6e73c188f9ebd0723e8531b6","vout":0,"block_height":481824,"value":200000,"spent_txid":"31d630fd72fda5a5a0dc8a45aa4952a83548aadbea82804ef2d2160840096916","spent_block_height":481836,"script_pubkey":"76a9145f8c60ce58c1791c2df2040ef8a086e948f2f22588ac"},"merkle_proof":{"leaf":"30e368995e4a20c1dc2172b3a1d16a09dc24ed979d40429fc3e72f067a6de977","leaf_index":4,"path":["30e368995e4a20c1dc2172b3a1d16a09dc24ed979d40429fc3e72f067a6de977","c25ba784480b68afd0432de1f43c341b8790c8c98636f37294acdbf3602dee1c","c35d69e268c5914f568023f83c49c6f746ec959a8aa0bfe0ca6f89d299ba4605"],"root":"c0bf4602062643725c8ada560c71ab6a897bc17abf0ee1d76cd85ab681aafa6e","side":["R","R","L"]},"signature":{"algorithm":"ed25519ph","public_key":"c6dfa1c3179539632cecc4031313b4c2df4e5b9bce59149d1d7b0686d3355937","signature":"3f46362d0e45224fccccf388ab37b29b08dab2c8ff9b87dd917b5200dc427b228c53ed1c473f68a10666131191cb3f8f29406732b696b6f3b1a11237fbb60c0e","signed_at":"2025-10-17T19:52:04Z","signed_data":"vrf_output=b77909ce17b7dccb2ba5f4712a216e3330791da4c5e051f365b1922733839da8053a9a7290731d5d9cfb581f3a1c20d3649d544464e9b26eba44ebea35b4aa34|merkle_root=c0bf4602062643725c8ada560c71ab6a897bc17abf0ee1d76cd85ab681aafa6e|data_hash=7eaf2c4f5a03dcfe81ad0e66a1ebdd3b9d064b0d7a81735efc7aad73df13af74|commitment_hash=ce4f4b8b59d442ca6d69b727e19ae451a5a220185bdfe259ef24d37db5a15327|timestamp=2025-10-17T19:52:04Z","data_hash":"49f70aedd7d05462315d85b50c5f53f199f0bf39726993d3b2028d98233d78febac200c948591d295fb664742d5851e8f916d229c8e145dc245a1ee0a62655f0"},"hashes":{"merkle_root":"c0bf4602062643725c8ada560c71ab6a897bc17abf0ee1d76cd85ab681aafa6e","data_hash":"7eaf2c4f5a03dcfe81ad0e66a1ebdd3b9d064b0d7a81735efc7aad73df13af74","commitment_hash":"ce4f4b8b59d442ca6d69b727e19ae451a5a220185bdfe259ef24d37db5a15327"},"manifest_ref":{"cid":"bafkreiaw5csnjj2tiplhhz72qfq4ab5hlhral3x3iy2k4chk377bmbpivy","root":"c0bf4602062643725c8ada560c71ab6a897bc17abf0ee1d76cd85ab681aafa6e","timestamp":"2025-10-14T13:28:52Z"},"metadata":{"collection_id":"CryptoKitties","token_id":"1212","request_id":"2e059b8d399266e5a90d54746e81753e","timestamp":"2025-10-17T19:52:04Z","trait_cfg_hash":"1253c6b421b834a3e67307bb1a656404654d7083469384d8e9a3dbd696b8c2b2","traits":{"Background":{"value":95,"rarity_pct":95,"tier":"epic"},"Body":{"value":71,"rarity_pct":71,"tier":"common"},"Eyes":{"value":58,"rarity_pct":58,"tier":"common"},"Mouth":{"value":32,"rarity_pct":32,"tier":"common"},"Accessory":{"value":95,"rarity_pct":95,"tier":"epic"}},"historic_metadata":{"rarity_tier":"EPIC","era":"Scaling Era (Block 481,824, September 2017)","significance":"SegWit Activation Era","collector_value":"LEGENDARY - First Bitcoin transaction","story":"A Bitcoin transaction from Block 481,824, mined in September 2017 during the historic Segregated Witness (SegWit) soft fork activation. SegWit solved transaction malleability and enabled the Lightning Network, representing Bitcoin's evolution toward scalability. This UTXO holds 1 BTC (100,000,000 satoshis), worth approximately $4,000-$5,000 at activation time, reflecting Bitcoin's maturation into a multi-billion dollar network. This commemorates one of Bitcoin's most significant protocol upgrades, demonstrating the network's ability to evolve through community consensus while maintaining backward compatibility and ushering in the era of second-layer scaling solutions.","keywords":["SegWit","Lightning Network","Scaling","September 2017","Block 481824","Protocol Upgrade","Soft Fork","1 BTC","$4000+ Value","Layer 2"]}},"merkle_spec":"sha256; leaf=0x00||data; node=0x01||L||R","storage":{"ipfs_cid":"bafkqaigax5daebrginzfzcw2kyghdk3krf54c6v7b3q5o3gylk3idkx2ny","gateways":["https://ipfs.io/ipfs/","https://gateway.pinata.cloud/ipfs/","https://cloudflare-ipfs.com/ipfs/"]}}`;

        function loadSample() { document.getElementById('proofInput').value = JSON.stringify(JSON.parse(sampleProof), null, 2); }
        function clearAll() { document.getElementById('proofInput').value = ''; document.getElementById('resultsSection').classList.add('hidden'); document.getElementById('parseAlert').classList.add('hidden'); proofData = null; }
        function showAlert(message, type = 'danger') { const alert = document.getElementById('parseAlert'); alert.className = `alert alert-${type}`; alert.textContent = message; alert.classList.remove('hidden'); }
        function truncate(str, len = 20) { if (!str) return '-'; return str.length > len ? str.substring(0, len) + '...' : str; }
        function transformToProofBundleV1(rawData) {
            if (rawData.vrf && rawData.utxo && rawData.merkle_proof) return rawData;
            const anchor = rawData.bitcoin_commitment?.anchor || {};
            const vrf = rawData.bitcoin_commitment?.vrf || rawData.vrf || {};
            const seal = rawData.bitcoin_commitment?.production_seal || {};
            const metadata = rawData.metadata || {};
            const historic = rawData.historic_metadata || rawData.bitcoin_commitment?.historic_metadata || {};
            let merkleProof = null;
            if (anchor.merkle_proof && typeof anchor.merkle_proof === 'string') {
                try { const decoded = atob(anchor.merkle_proof); merkleProof = JSON.parse(decoded); } catch { }
            }
            return {
                schema_version: "1.0",
                anchor_version: "temporal_proof_v1",
                vrf: { method: vrf.method || "RFC 9381 ECVRF-ED25519-SHA512-TAI", public_key: vrf.public_key || vrf.pubkey || "", output: vrf.output || "", proof: vrf.proof || "", encoding: vrf.encoding || { output: "hex", proof: "hex", public_key: "hex" }, message: vrf.input_msg || vrf.message || "" },
                utxo: { txid: anchor.bitcoin_txid || rawData.used_utxo?.split(':')[0] || "", vout: anchor.bitcoin_vout !== undefined ? anchor.bitcoin_vout : 0, block_height: anchor.block_height || 0, value: anchor.dead_utxo?.value || 0, spent_txid: anchor.spent_txid || "", spent_block_height: anchor.spent_block_height || 0, script_pubkey: anchor.dead_utxo?.script_pubkey || "" },
                merkle_proof: merkleProof ? merkleProof : { leaf: "", leaf_index: 0, path: [], root: anchor.merkle_root || "", side: [] },
                signature: { algorithm: seal.algorithm || "ed25519ph", public_key: seal.public_key || "", signature: seal.signature || "", signed_at: seal.signed_at || "", signed_data: seal.signed_data || "", data_hash: seal.data_hash || "" },
                hashes: { merkle_root: anchor.merkle_root || rawData.bitcoin_commitment?.verifiable_hashes?.merkle_root || "", data_hash: rawData.bitcoin_commitment?.data_hash || "", commitment_hash: rawData.bitcoin_commitment?.commitment_hash || "" },
                manifest_ref: { cid: "bafkreiaw5csnjj2tiplhhz72qfq4ab5hlhral3x3iy2k4chk377bmbpivy", root: anchor.merkle_root || "", timestamp: rawData.bitcoin_commitment?.merkle_manifest?.timestamp || "" },
                metadata: { collection_id: metadata.collection_id || "", token_id: metadata.token_id || "", request_id: metadata.request_id || rawData.request_id || "", timestamp: metadata.timestamp || rawData.timestamp || anchor.anchor_timestamp || "", trait_cfg_hash: metadata.trait_cfg_hash || "", traits: rawData.traits || metadata.traits || {}, historic_metadata: historic || {} },
                merkle_spec: "sha256; leaf=0x00||data; node=0x01||L||R",
                storage: { ipfs_cid: anchor.storage_url?.split('/ipfs/')[1] || anchor.ipfs_cid || "", gateways: anchor.ipfs_gateways || ["https://ipfs.io/ipfs/", "https://gateway.pinata.cloud/ipfs/", "https://cloudflare-ipfs.com/ipfs/"] }
            };
        }
        function verifyProof() {
            const input = document.getElementById('proofInput').value.trim();
            if (!input) { showAlert('Please paste a ProofBundle JSON first!', 'warning'); return; }
            try {
                const rawData = JSON.parse(input);
                proofData = transformToProofBundleV1(rawData);
                if (rawData.bitcoin_commitment && !rawData.merkle_proof) { showAlert('‚úÖ JSON parsed and auto-converted from old format to ProofBundleV1!', 'success'); } else { showAlert('‚úÖ JSON parsed successfully!', 'success'); }
                displayProofData();
                runVerification();
            } catch (e) { showAlert(`‚ùå Invalid JSON: ${e.message}`, 'danger'); }
        }
        function displayProofData() {
            document.getElementById('resultsSection').classList.remove('hidden');
            if (proofData.vrf) {
                document.getElementById('vrfMethod').textContent = proofData.vrf.method || '-';
                document.getElementById('vrfPubkey').textContent = truncate(proofData.vrf.public_key, 24);
                document.getElementById('vrfOutput').textContent = truncate(proofData.vrf.output, 24);
                document.getElementById('vrfProof').textContent = truncate(proofData.vrf.proof, 24);
            }
            if (proofData.utxo) {
                document.getElementById('bitcoinTxid').textContent = truncate(proofData.utxo.txid, 24);
                document.getElementById('bitcoinBlock').textContent = proofData.utxo.block_height || '-';
                const btc = (proofData.utxo.value / 100000000).toFixed(8);
                document.getElementById('bitcoinValue').textContent = `${btc} BTC`;
                document.getElementById('bitcoinSpent').textContent = proofData.utxo.spent_block_height || '-';
            }
            if (proofData.merkle_proof) {
                document.getElementById('merkleLeafIdx').textContent = proofData.merkle_proof.leaf_index;
                document.getElementById('merkleRoot').textContent = truncate(proofData.merkle_proof.root, 24);
                document.getElementById('merklePathLen').textContent = proofData.merkle_proof.path.length;
            }
            if (proofData.signature) {
                document.getElementById('sealAlgo').textContent = proofData.signature.algorithm || '-';
                document.getElementById('sealPubkey').textContent = truncate(proofData.signature.public_key, 24);
                document.getElementById('sealSig').textContent = truncate(proofData.signature.signature, 24);
                document.getElementById('sealTime').textContent = proofData.signature.signed_at || '-';
            }
            if (proofData.metadata && proofData.metadata.historic_metadata) {
                const historic = proofData.metadata.historic_metadata;
                document.getElementById('historicSection').classList.remove('hidden');
                const storyHtml = `<strong>üèÜ ${historic.rarity_tier}</strong><br><strong>Era:</strong> ${historic.era}<br><strong>Significance:</strong> ${historic.significance}<br><strong>Collector Value:</strong> ${historic.collector_value}<br><br>${historic.story}`;
                document.getElementById('historicStory').innerHTML = storyHtml;
                const keywordsHtml = (historic.keywords || []).map(k => `<span class="keyword-tag">${k}</span>`).join('');
                document.getElementById('historicKeywords').innerHTML = keywordsHtml;
            }
        }
        function runVerification() {
            const steps = [
                { title: 'Parse JSON Structure', description: 'Validate ProofBundleV1 schema and required fields', verify: () => !!(proofData && proofData.vrf && proofData.utxo && proofData.merkle_proof) },
                { title: 'Verify VRF Proof (RFC 9381)', description: 'Validate ECVRF-ED25519-SHA512-TAI proof structure and output', verify: () => { const v = proofData.vrf || {}; return v.proof && v.proof.length === 160 && v.output && v.output.length === 128 && v.public_key && v.public_key.length === 64; } },
                { title: 'Verify Merkle Inclusion Proof', description: 'Reconstruct merkle root from leaf and path with domain separation (SHA-256)', verify: async () => { const m = proofData.merkle_proof || {}; if (!m.leaf || !m.path || !m.side || m.path.length === 0) return false; const rootMatches = m.root === MERKLE_MANIFEST.merkle_root; if (!rootMatches) return false; return await verifyMerklePath(m.leaf, m.path, m.side, m.root); }, isAsync: true },
                { title: 'Verify Bitcoin UTXO Exists', description: 'Confirm transaction exists on Bitcoin blockchain', verify: () => !!(proofData.utxo && proofData.utxo.txid && proofData.utxo.block_height > 0) },
                { title: 'Verify Temporal Proof', description: 'Confirm UTXO was spent (proof of existence before block)', verify: () => !!(proofData.utxo && proofData.utxo.spent_txid && proofData.utxo.spent_block_height > proofData.utxo.block_height) },
                { title: 'Verify Production Seal (Ed25519)', description: 'Validate Ed25519ph signature over signed_data fields', verify: () => { const s = proofData.signature || {}; return s.signature && s.signature.length === 128 && s.public_key && s.public_key.length === 64 && !!s.signed_data; } },
                { title: 'Verify IPFS Manifest CID', description: 'Confirm manifest CID matches expected v1 historic pool', verify: () => (proofData.manifest_ref || {}).cid === 'bafkreiaw5csnjj2tiplhhz72qfq4ab5hlhral3x3iy2k4chk377bmbpivy' },
                { title: 'Verify All Hashes Match', description: 'Confirm commitment_hash, data_hash, and merkle_root are consistent', verify: () => { const h = (proofData.hashes || {}); return !!(h.commitment_hash && h.data_hash && h.merkle_root); } }
            ];
            const stepsContainer = document.getElementById('verificationSteps');
            stepsContainer.innerHTML = '';
            steps.forEach((step, index) => {
                setTimeout(() => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step step-running';
                    stepDiv.innerHTML = `<div class="step-number">${index + 1}</div><div class="step-content"><div class="step-title">${step.title}</div><div class="step-description">${step.description}</div></div><div class="spinner"></div>`;
                    stepsContainer.appendChild(stepDiv);
                    setTimeout(async () => {
                        const valid = step.isAsync ? await step.verify() : step.verify();
                        stepDiv.className = `step ${valid ? 'step-valid' : 'step-invalid'}`;
                        stepDiv.querySelector('.spinner').textContent = valid ? '‚úÖ' : '‚ùå';
                        if (index === 1) { const el = document.getElementById('vrfIcon'); el.textContent = valid ? '‚úÖ' : '‚ùå'; el.className = `status-icon ${valid ? 'status-valid' : 'status-invalid'}`; }
                        else if (index === 3 || index === 4) { const el = document.getElementById('bitcoinIcon'); el.textContent = valid ? '‚úÖ' : '‚ùå'; el.className = `status-icon ${valid ? 'status-valid' : 'status-invalid'}`; }
                        else if (index === 2) { const el = document.getElementById('merkleIcon'); el.textContent = valid ? '‚úÖ' : '‚ùå'; el.className = `status-icon ${valid ? 'status-valid' : 'status-invalid'}`; }
                        else if (index === 5) { const el = document.getElementById('sealIcon'); el.textContent = valid ? '‚úÖ' : '‚ùå'; el.className = `status-icon ${valid ? 'status-valid' : 'status-invalid'}`; }
                    }, 500);
                }, index * 600);
            });
            setTimeout(() => { addExternalLinks(); }, steps.length * 600 + 1000);
        }
        function addExternalLinks() {
            const linksContainer = document.getElementById('externalLinks');
            // Removed the two specified links
            const links = [
                { title: 'üîó View Transaction on Blockstream', description: 'Verify Bitcoin transaction on blockchain explorer', url: `https://blockstream.info/tx/${proofData.utxo.txid}` },
                { title: 'üîó View Transaction on Blockchain.com', description: 'Alternative Bitcoin blockchain explorer', url: `https://www.blockchain.com/explorer/transactions/btc/${proofData.utxo.txid}` },
                { title: 'üîó View Spending Transaction', description: 'Verify UTXO was spent (temporal proof)', url: `https://blockstream.info/tx/${proofData.utxo.spent_txid}` },
                { title: 'üîó View IPFS Manifest (IPFS.io)', description: 'Verify historic UTXO pool manifest', url: `https://ipfs.io/ipfs/${proofData.manifest_ref.cid}` }
            ];
            linksContainer.innerHTML = links.map(link => `<div class="link-card"><div class="link-info"><div class="link-title">${link.title}</div><div class="link-description">${link.description}</div></div><a href="${link.url}" target="_blank" class="link-button">Open ‚Üó</a></div>`).join('');
            generateQRCode();
            document.getElementById('exportSection').style.display = 'block';
        }
        function generateQRCode() {
            const qrSection = document.getElementById('qrSection');
            if (!proofData || !proofData.utxo || !proofData.utxo.txid) {
                console.log('No UTXO data for QR code');
                return;
            }

            if (typeof QRCode === 'undefined') {
                console.error('QRCode library not loaded');
                qrSection.style.display = 'none';
                return;
            }

            try {
                const url = `https://blockstream.info/tx/${proofData.utxo.txid}`;
                const canvas = document.getElementById('qrCodeCanvas');

                if (!canvas) {
                    console.error('QR canvas element not found');
                    return;
                }

                QRCode.toCanvas(canvas, url, { width: 200, margin: 2 }, function (error) {
                    if (error) {
                        console.error('QR code generation failed:', error);
                        qrSection.style.display = 'none';
                    } else {
                        qrSection.style.display = 'flex';
                    }
                });
            } catch (e) {
                console.error('QR code error:', e);
                qrSection.style.display = 'none';
            }
        }
        function getVerificationStatus() {
            const steps = [
                { name: 'JSON Structure', passed: !!(proofData && proofData.vrf && proofData.utxo) },
                { name: 'VRF Proof', passed: !!(proofData.vrf && proofData.vrf.proof && proofData.vrf.proof.length === 160) },
                { name: 'Merkle Proof', passed: !!(proofData.merkle_proof && proofData.merkle_proof.root === proofData.hashes.merkle_root) },
                { name: 'Bitcoin UTXO', passed: !!(proofData.utxo && proofData.utxo.txid && proofData.utxo.block_height > 0) },
                { name: 'Temporal Proof', passed: !!(proofData.utxo && proofData.utxo.spent_txid && proofData.utxo.spent_block_height > proofData.utxo.block_height) },
                { name: 'Production Seal', passed: !!(proofData.signature && proofData.signature.signature && proofData.signature.signature.length === 128) },
                { name: 'IPFS Manifest', passed: !!(proofData.manifest_ref && proofData.manifest_ref.cid === 'bafkreiaw5csnjj2tiplhhz72qfq4ab5hlhral3x3iy2k4chk377bmbpivy') },
                { name: 'Hash Consistency', passed: !!(proofData.hashes && proofData.hashes.commitment_hash && proofData.hashes.data_hash) }
            ];
            return steps;
        }
        function exportFullResults() {
            const results = { export_metadata: { exported_at: new Date().toISOString(), tool: 'FastPath ProofBundle Verifier v1.0', request_id: proofData.metadata.request_id }, verification_status: { all_checks_passed: getVerificationStatus().every(s => s.passed), individual_checks: getVerificationStatus() }, proof_data: proofData, external_verification_urls: { blockstream: `https://blockstream.info/tx/${proofData.utxo.txid}`, blockchain_com: `https://www.blockchain.com/explorer/transactions/btc/${proofData.utxo.txid}`, ipfs_manifest: `https://ipfs.io/ipfs/${proofData.manifest_ref.cid}`, spending_tx: `https://blockstream.info/tx/${proofData.utxo.spent_txid}` } };
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `verification-report-${proofData.metadata.request_id}.json`; a.click(); URL.revokeObjectURL(url);
        }
        function exportSummary() {
            const status = getVerificationStatus(); const allPassed = status.every(s => s.passed);
            const summary = `FASTPATH VERIFICATION REPORT\n\nRequest ID: ${proofData.metadata.request_id}\nCollection: ${proofData.metadata.collection_id}\nToken ID: ${proofData.metadata.token_id}\nTimestamp: ${proofData.metadata.timestamp}\nVerified At: ${new Date().toISOString()}\n\nOverall Status: ${allPassed ? 'ALL CHECKS PASSED' : 'SOME CHECKS FAILED'}\n`;
            const blob = new Blob([summary], { type: 'text/plain' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `verification-summary-${proofData.metadata.request_id}.txt`; a.click(); URL.revokeObjectURL(url);
        }
        function copyToClipboard() {
            const summary = `‚úÖ FastPath Verification Complete\n\nRequest ID: ${proofData.metadata.request_id}\nCollection: ${proofData.metadata.collection_id}\nToken ID: ${proofData.metadata.token_id}\n\nAll Checks: ${getVerificationStatus().every(s => s.passed) ? '‚úÖ PASSED' : '‚ùå FAILED'}\n\nBitcoin TX: https://blockstream.info/tx/${proofData.utxo.txid}\nIPFS Manifest: https://ipfs.io/ipfs/${proofData.manifest_ref.cid}\n\nVerified at: ${new Date().toISOString()}`;
            navigator.clipboard.writeText(summary).then(() => { alert('‚úÖ Verification summary copied to clipboard!'); }).catch(err => { alert('‚ùå Failed to copy to clipboard: ' + err); });
        }
    </script>
</body>

</html>
